<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Свадебная фотобудка</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Предотвращает масштабирование по двойному тапу на мобильных устройствах */
        }
        .font-serif-display {
            font-family: 'Playfair Display', serif;
        }
        /* Стили для плавного появления элементов */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Стилизация камеры для заполнения экрана */
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
        }
        .camera-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Начальный экран -->
    <div id="welcome-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-6 fade-in">
        <h1 class="font-serif-display text-4xl md:text-5xl text-gray-900">Поздравляем!</h1>
        <p class="mt-4 text-lg text-gray-600">Поделитесь лучшими моментами этого дня!</p>
        <p class="mt-2 text-sm text-gray-500">Вы можете сделать до 25 фотографий.</p>
        <button id="start-camera-btn" class="mt-8 bg-rose-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-rose-600 transition-transform transform hover:scale-105">
            Открыть камеру
        </button>
        <p id="error-message" class="mt-4 text-red-500 font-medium hidden max-w-md"></p>
    </div>

    <!-- Экран с камерой -->
    <div id="camera-screen" class="hidden">
        <div class="camera-container">
            <video id="camera-view" playsinline autoplay muted></video>
        </div>
        
        <!-- Элементы управления камерой -->
        <div class="camera-controls">
            <!-- Кнопка переключения камеры -->
            <button id="switch-camera-btn" class="absolute left-4 bottom-8 text-white bg-black bg-opacity-30 p-3 rounded-full hover:bg-opacity-50 transition hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><path d="m20 12-3-3-3 3"/><path d="m4 12 3 3 3-3"/></svg>
            </button>

            <!-- Кнопка "Сделать фото" -->
            <button id="take-photo-btn" class="w-20 h-20 bg-white rounded-full border-4 border-white ring-2 ring-offset-2 ring-offset-black/50 ring-rose-500 shadow-xl transition-transform transform active:scale-90"></button>
            
            <!-- Счетчик оставшихся фото -->
            <div class="absolute right-4 bottom-9 text-white bg-black bg-opacity-30 px-3 py-1 rounded-full text-center">
                <span id="photo-counter" class="font-bold text-lg">25</span>
                <span class="text-xs block">фото</span>
            </div>
        </div>
        
        <!-- Галерея сделанных фото -->
        <div id="gallery-container" class="fixed top-4 left-4 flex flex-wrap gap-2">
            <!-- Сюда будут добавляться миниатюры фото -->
        </div>

        <!-- Скрытый canvas для захвата изображения -->
        <canvas id="photo-canvas" class="hidden"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Элементы интерфейса ---
            const welcomeScreen = document.getElementById('welcome-screen');
            const cameraScreen = document.getElementById('camera-screen');
            const startCameraBtn = document.getElementById('start-camera-btn');
            const errorMessage = document.getElementById('error-message');
            
            const videoElement = document.getElementById('camera-view');
            const takePhotoBtn = document.getElementById('take-photo-btn');
            const switchCameraBtn = document.getElementById('switch-camera-btn');
            const photoCounterEl = document.getElementById('photo-counter');
            const galleryContainer = document.getElementById('gallery-container');
            const canvas = document.getElementById('photo-canvas');
            const context = canvas.getContext('2d');

            // --- Настройки ---
            const PHOTO_LIMIT = 25;
            let currentStream;
            let currentFacingMode = 'environment'; // 'environment' - задняя камера, 'user' - передняя

            // --- Состояние приложения ---
            let photosTaken = parseInt(localStorage.getItem('weddingPhotosTakenCount') || '0');

            // --- Функции ---

            // Инициализация приложения
            function init() {
                // Проверяем базовую поддержку API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    displayError("К сожалению, ваш браузер не поддерживает функцию камеры.");
                    startCameraBtn.disabled = true;
                    return;
                }
                // Камера требует безопасного соединения (HTTPS)
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    displayError("Для доступа к камере сайт должен быть открыт по защищенному протоколу (https://). Пожалуйста, проверьте адрес сайта.");
                    startCameraBtn.disabled = true;
                    startCameraBtn.style.backgroundColor = '#ccc';
                    return;
                }

                updatePhotoCounter();
                startCameraBtn.addEventListener('click', startCamera);
                takePhotoBtn.addEventListener('click', takePhoto);
                switchCameraBtn.addEventListener('click', switchCamera);
                loadPhotosFromStorage();
            }

            // Запуск и настройка камеры
            async function startCamera() {
                errorMessage.classList.add('hidden'); // Скрываем старые ошибки
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                try {
                    // Пытаемся запустить камеру с текущими настройками
                    currentStream = await getCameraStream(currentFacingMode);
                } catch (err) {
                    console.warn(`Не удалось запустить камеру '${currentFacingMode}'. Пробуем другую. Ошибка: ${err.name}`);
                    const fallbackFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                    try {
                        // Если не получилось, пробуем запасной вариант
                        currentStream = await getCameraStream(fallbackFacingMode);
                        currentFacingMode = fallbackFacingMode; // Обновляем режим, если получилось
                    } catch (fallbackErr) {
                        console.error(`Не удалось запустить ни одну камеру. Ошибка: ${fallbackErr.name}`);
                        handleCameraError(fallbackErr);
                        return; // Выходим, если обе попытки провалились
                    }
                }
                
                // Если поток получен, показываем экран камеры
                videoElement.srcObject = currentStream;
                welcomeScreen.classList.add('hidden');
                cameraScreen.classList.remove('hidden');
                cameraScreen.classList.add('fade-in');
                checkCameraSwitchAvailability();
            }
            
            // Вспомогательная функция для получения потока с камеры
            function getCameraStream(facingMode) {
                const constraints = {
                    video: {
                        facingMode: { exact: facingMode },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                return navigator.mediaDevices.getUserMedia(constraints);
            }
            
            // Обработка финальных ошибок камеры
            function handleCameraError(err) {
                let message = "Произошла неизвестная ошибка при доступе к камере.";
                if (err.name === "NotAllowedError") {
                    message = "Вы не разрешили доступ к камере. Пожалуйста, обновите страницу и предоставьте разрешение во всплывающем окне.";
                } else if (err.name === "NotFoundError" || err.name === "OverconstrainedError" || err.name === "NotReadableError") {
                    message = "Не удалось найти подходящую камеру на вашем устройстве. Убедитесь, что она не используется другим приложением.";
                }
                displayError(message);
            }

            // Отображение сообщения об ошибке на главном экране
            function displayError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                welcomeScreen.classList.remove('hidden');
                cameraScreen.classList.add('hidden');
            }

            // Проверка возможности переключения камеры
            async function checkCameraSwitchAvailability() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoInputs = devices.filter(device => device.kind === 'videoinput');
                    if (videoInputs.length > 1) {
                        switchCameraBtn.classList.remove('hidden');
                    } else {
                        switchCameraBtn.classList.add('hidden');
                    }
                } catch(e) {
                    console.error("Не удалось получить список устройств", e);
                    switchCameraBtn.classList.add('hidden');
                }
            }

            // Переключение между камерами
            function switchCamera() {
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                console.log(`Переключение камеры на: ${currentFacingMode}`);
                startCamera();
            }

            // Функция "Сделать фото"
            function takePhoto() {
                if (photosTaken >= PHOTO_LIMIT) {
                    // Используем кастомное сообщение вместо alert
                    displayError('Вы достигли лимита в 25 фотографий!');
                    setTimeout(() => errorMessage.classList.add('hidden'), 3000);
                    return;
                }

                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);

                displayPhotoInGallery(imageDataUrl);
                savePhotoToStorage(imageDataUrl);
                
                photosTaken++;
                localStorage.setItem('weddingPhotosTakenCount', photosTaken);
                updatePhotoCounter();
            }

            // Обновление счетчика на экране
            function updatePhotoCounter() {
                const remaining = PHOTO_LIMIT - photosTaken;
                photoCounterEl.textContent = remaining;
                if (remaining <= 0) {
                    takePhotoBtn.disabled = true;
                    takePhotoBtn.style.backgroundColor = '#ccc';
                    takePhotoBtn.style.cursor = 'not-allowed';
                }
            }
            
            // Отображение миниатюры в галерее
            function displayPhotoInGallery(imageDataUrl) {
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.className = 'w-16 h-16 object-cover rounded-md border-2 border-white shadow-md fade-in';
                galleryContainer.appendChild(img);
            }

            // Сохранение фото в localStorage
            function savePhotoToStorage(imageDataUrl) {
                const photos = JSON.parse(localStorage.getItem('weddingPhotos') || '[]');
                photos.push(imageDataUrl);
                localStorage.setItem('weddingPhotos', JSON.stringify(photos));

                // --- ВАЖНО ДЛЯ РАЗРАБОТЧИКА ---
                // Здесь можно добавить код для загрузки фото на сервер.
            }

            // Загрузка сохраненных фото при открытии страницы
            function loadPhotosFromStorage() {
                const photos = JSON.parse(localStorage.getItem('weddingPhotos') || '[]');
                photos.forEach(displayPhotoInGallery);
            }

            // Запускаем приложение
            init();
        });
    </script>
</body>
</html>
