<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Свадебная фотобудка Ильи и Алины</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- JSZip для создания архива -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .font-wedding-title {
            font-family: 'Dancing Script', cursive;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
        }
        .camera-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Анимация для всплывающего окна */
        @keyframes modal-scale-in {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-content {
            animation: modal-scale-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Стиль для всплывающего уведомления */
        #notification-popup {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #notification-popup.show {
            top: 20px;
        }
        /* Стиль для модального окна просмотра фото */
        #photo-viewer-modal {
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 70;
        }
        /* Кастомный стиль для ползунка зума */
        #zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #fff;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #zoom-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #fff;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        #zoom-slider:hover::-webkit-slider-thumb {
            background: #f1f1f1;
        }
        #zoom-slider:hover::-moz-range-thumb {
            background: #f1f1f1;
        }
    </style>
</head>
<body class="bg-rose-50 text-gray-800">

    <!-- Модальное окно для ввода имени -->
    <div id="name-input-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Как к вам обращаться?</h2>
            <p class="text-sm text-gray-600 mb-6">Ваше имя будет добавлено на каждую фотографию.</p>
            <input type="text" id="user-name-input" placeholder="Введите ваше имя" class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-rose-500 transition mb-4">
            <button id="submit-name-btn" class="w-full bg-rose-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-rose-600 transition-all transform hover:scale-105 active:scale-95">
                Продолжить
            </button>
            <p id="name-error-message" class="mt-4 text-red-500 font-medium hidden"></p>
        </div>
    </div>

    <!-- Начальный экран -->
    <div id="welcome-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-6 fade-in bg-rose-50 hidden">
        <div class="p-8 md:p-12 rounded-3xl bg-white shadow-xl max-w-lg w-full transform transition-transform hover:scale-105">
            <h1 class="font-wedding-title text-5xl md:text-6xl text-rose-500">
                Илья & Алина
            </h1>
            <p class="mt-4 text-xl md:text-2xl font-medium text-gray-700">
                28.08.2025
            </p>
            <p class="mt-2 text-lg text-gray-600">
                Поделитесь лучшими моментами этого дня!
            </p>
            <p class="mt-4 text-sm text-gray-500">Вы можете сделать до 25 фотографий.</p>
            <button id="start-camera-btn" class="mt-8 bg-rose-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-rose-600 transition-all transform hover:scale-105 active:scale-95">
                Открыть камеру
            </button>
            <p id="error-message" class="mt-4 text-red-500 font-medium hidden max-w-md"></p>
        </div>
    </div>

    <!-- Экран с камерой -->
    <div id="camera-screen" class="hidden">
        <div class="camera-container">
            <video id="camera-view" playsinline autoplay muted></video>
        </div>
        
        <!-- Элементы управления камерой -->
        <div class="camera-controls">
            <button id="switch-camera-btn" class="absolute left-4 bottom-8 text-white bg-white/30 backdrop-blur-sm p-3 rounded-full hover:bg-white/50 transition hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/><path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/><path d="m20 12-3-3-3 3"/><path d="m4 12 3 3 3-3"/></svg>
            </button>

            <button id="take-photo-btn" class="w-20 h-20 rounded-full transition-transform transform active:scale-90 flex items-center justify-center p-2 bg-transparent">
                <img src="https://raw.githubusercontent.com/Suno2036/qr/main/White%20and%20Black%20Simple%20Initial%20Wedding%20Logo.png" 
                     alt="Сделать фото" 
                     class="w-full h-full object-contain"
                     onerror="this.onerror=null;this.src='https://placehold.co/100x100/ffffff/000000?text=Logo'">
            </button>
            
            <div class="absolute right-4 bottom-9 text-white bg-white/30 backdrop-blur-sm px-3 py-1 rounded-full text-center">
                <span id="photo-counter" class="font-bold text-lg">25</span>
                <span class="text-xs block">фото</span>
            </div>
        </div>
        
        <div id="zoom-controls" class="absolute left-1/2 bottom-20 transform -translate-x-1/2 w-3/4 max-w-sm hidden">
            <input type="range" id="zoom-slider" min="1" max="1" value="1" step="0.1" class="w-full h-2 bg-white/30 rounded-lg appearance-none cursor-pointer backdrop-blur-sm">
        </div>

        <!-- Галерея и кнопка Поделиться/Скачать -->
        <div class="fixed top-4 left-4 flex flex-col items-start gap-2">
            <div id="gallery-container" class="flex flex-wrap gap-2"></div>
            <!-- UPDATED: Кнопка теперь называется "Поделиться" -->
            <button id="share-or-download-btn" class="mt-2 text-white bg-rose-500 backdrop-blur-sm px-4 py-2 rounded-full font-bold text-sm hidden hover:bg-rose-600 transition shadow-lg">
                Поделиться фото
            </button>
        </div>

        <canvas id="photo-canvas" class="hidden"></canvas>
    </div>

    <!-- Кастомное всплывающее окно для сообщений -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div id="message-box-content" class="modal-content bg-white p-6 rounded-xl shadow-2xl text-center max-w-sm w-full">
            <p id="message-box-text" class="text-lg font-semibold text-gray-800"></p>
            
            <!-- Контейнер для инструкций (для браузеров без Web Share API) -->
            <div id="manual-share-instructions" class="hidden text-left">
                <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">Готово!</h3>
                <p class="text-sm text-gray-600 mb-4 border-b pb-3">
                    <span class="font-bold">Шаг 1:</span> Мы сохранили ZIP-архив с вашими фото в папку 'Загрузки' (Downloads).
                </p>
                <p class="text-sm text-gray-600 mb-4">
                   <span class="font-bold">Шаг 2:</span> Теперь, пожалуйста, отправьте этот файл молодоженам. Нажмите на кнопку ниже, и когда откроется приложение, **прикрепите скачанный ZIP-файл к сообщению!**
                </p>
                <div id="share-buttons-container" class="mt-4 space-y-2">
                    <a id="share-telegram" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-600 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.226.615.428.927.393.277-.03.542-.235.666-.921.157-.858.278-2.015.283-2.14.007-.184-.01-1.052-.046-1.358-.04-.326-.278-.54-.566-.54-.163 0-.354.09-.524.26z"/></svg>
                        Открыть Telegram
                    </a>
                    <a id="share-whatsapp" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full bg-green-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-600 transition-all">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                        Открыть WhatsApp
                    </a>
                </div>
            </div>

            <button id="message-box-close" class="mt-4 px-6 py-2 bg-rose-500 text-white rounded-full hover:bg-rose-600 transition-colors">OK</button>
        </div>
    </div>

    <div id="notification-popup" class="w-full max-w-sm bg-white rounded-xl shadow-lg p-3 flex items-center gap-3">
        <img id="notification-image" src="https://raw.githubusercontent.com/Suno2036/qr/main/a19abaa4-3c2f-46c8-9263-af6d4d80be2e.jpeg" 
             class="w-12 h-12 object-cover rounded-full border-2 border-white shadow-sm"
             alt="Илья и Алина">
        <div class="flex-1">
            <p class="font-bold text-sm text-gray-900">Илья и Алина</p>
            <p id="notification-message" class="text-sm text-gray-600 mt-1"></p>
        </div>
    </div>

    <audio id="notification-sound" src="https://raw.githubusercontent.com/Suno2036/qr/main/notification-sound-for-messenger-messages.mp3" preload="auto"></audio>

    <div id="photo-viewer-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden">
        <button id="close-photo-viewer" class="absolute top-4 right-4 text-white text-4xl">&times;</button>
        <img id="full-size-photo" src="" alt="Full size photo" class="max-w-full max-h-full object-contain">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Элементы интерфейса ---
            const nameInputModal = document.getElementById('name-input-modal');
            const userNameInput = document.getElementById('user-name-input');
            const submitNameBtn = document.getElementById('submit-name-btn');
            const nameErrorMessage = document.getElementById('name-error-message');

            const welcomeScreen = document.getElementById('welcome-screen');
            const cameraScreen = document.getElementById('camera-screen');
            const startCameraBtn = document.getElementById('start-camera-btn');
            
            const videoElement = document.getElementById('camera-view');
            const takePhotoBtn = document.getElementById('take-photo-btn');
            const switchCameraBtn = document.getElementById('switch-camera-btn');
            const photoCounterEl = document.getElementById('photo-counter');
            const galleryContainer = document.getElementById('gallery-container');
            const canvas = document.getElementById('photo-canvas');
            const context = canvas.getContext('2d');

            const messageBox = document.getElementById('message-box');
            const messageBoxText = document.getElementById('message-box-text');
            const messageBoxCloseBtn = document.getElementById('message-box-close');
            const manualShareInstructions = document.getElementById('manual-share-instructions'); 
            const shareTelegramBtn = document.getElementById('share-telegram');
            const shareWhatsappBtn = document.getElementById('share-whatsapp');
            
            const notificationPopup = document.getElementById('notification-popup');
            const notificationMessageEl = document.getElementById('notification-message');
            const notificationSound = document.getElementById('notification-sound');

            const photoViewerModal = document.getElementById('photo-viewer-modal');
            const fullSizePhoto = document.getElementById('full-size-photo');
            const closePhotoViewerBtn = document.getElementById('close-photo-viewer');
            
            const zoomControls = document.getElementById('zoom-controls');
            const zoomSlider = document.getElementById('zoom-slider');
            const shareOrDownloadBtn = document.getElementById('share-or-download-btn');

            // --- Настройки ---
            const PHOTO_LIMIT = 25;
            let currentStream;
            let currentFacingMode = 'environment';
            let userName = '';
            let supportsZoom = false;
            let currentZoom = 1.0;
            let minZoom = 1.0;
            let maxZoom = 1.0;
            let initialPinchDistance = null;

            const messages = [
                'Спасибо, что разделили с нами этот счастливый день!', 'Вы самый желанный гость! Рады видеть вас!', 'Мы очень ценим ваше присутствие.', 'Ваша улыбка делает наш день ярче!', 'Спасибо за все, что вы для нас значите.', 'Каждый момент сегодня бесценен, спасибо вам!', 'Мы очень рады, что вы здесь.', 'Это лучший день в нашей жизни, благодаря вам!', 'Спасибо за тепло и радость, которую вы принесли.', 'Ваш приход - это самый лучший подарок.', 'Мы так счастливы, что вы с нами.', 'Пусть этот день останется в памяти навсегда.', 'Ваше присутствие - это счастье!', 'Спасибо за вашу дружбу и любовь.', 'Этот день был бы неполным без вас.', 'Вы делаете наш праздник особенным!', 'Мы любим вас, спасибо что вы есть.', 'Надеемся, вам весело!', 'Этот день создан для веселья, и вы - его часть!', 'Спасибо, что помогаете нам праздновать.', 'Мы запомним этот день навсегда.', 'Спасибо за смех и добрые слова.', 'Мы так благодарны, что вы здесь!', 'Этот день - волшебство, и вы - его часть.', 'Спасибо, что вы с нами в начале нашего нового пути!'
            ];

            let photosTaken = parseInt(localStorage.getItem('weddingPhotosTakenCount') || '0');

            function init() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showMessage("К сожалению, ваш браузер не поддерживает функцию камеры.");
                    startCameraBtn.disabled = true;
                    return;
                }
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    showMessage("Для доступа к камере сайт должен быть открыт по защищенному протоколу (https://). Пожалуйста, проверьте адрес сайта.");
                    startCameraBtn.disabled = true;
                    startCameraBtn.style.backgroundColor = '#ccc';
                    return;
                }

                submitNameBtn.addEventListener('click', () => {
                    const name = userNameInput.value.trim();
                    if (name.length > 0) {
                        userName = name;
                        nameInputModal.classList.add('hidden');
                        welcomeScreen.classList.remove('hidden');
                        initAppFlow();
                    } else {
                        nameErrorMessage.textContent = 'Пожалуйста, введите ваше имя.';
                        nameErrorMessage.classList.remove('hidden');
                    }
                });

                messageBoxCloseBtn.addEventListener('click', () => {
                    messageBox.classList.add('hidden');
                    manualShareInstructions.classList.add('hidden');
                });
                
                closePhotoViewerBtn.addEventListener('click', () => {
                    photoViewerModal.classList.add('hidden');
                });

                shareOrDownloadBtn.addEventListener('click', shareOrDownloadPhotos);
            }
            
            function showMessage(text, showManualShareFlow = false) {
                if (showManualShareFlow) {
                    messageBoxText.classList.add('hidden');
                    manualShareInstructions.classList.remove('hidden');
                    
                    const shareText = encodeURIComponent(`Привет! Это фотографии со свадьбы Ильи и Алины от гостя по имени ${userName}. #ИльяАлина2025`);
                    shareTelegramBtn.href = `tg://msg_url?url=&text=${shareText}`;
                    shareWhatsappBtn.href = `https://api.whatsapp.com/send?text=${shareText}`;
                } else {
                    messageBoxText.textContent = text;
                    messageBoxText.classList.remove('hidden');
                    manualShareInstructions.classList.add('hidden');
                }
                messageBox.classList.remove('hidden');
            }

            function initAppFlow() {
                updatePhotoCounter();
                startCameraBtn.addEventListener('click', startCamera);
                takePhotoBtn.addEventListener('click', takePhoto);
                switchCameraBtn.addEventListener('click', switchCamera);
                loadPhotosFromStorage();
            }

            async function startCamera() {
                messageBox.classList.add('hidden'); 
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                try {
                    currentStream = await getCameraStream(currentFacingMode);
                } catch (err) {
                    const fallbackFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                    try {
                        currentStream = await getCameraStream(fallbackFacingMode);
                        currentFacingMode = fallbackFacingMode;
                    } catch (fallbackErr) {
                        handleCameraError(fallbackErr);
                        return;
                    }
                }
                videoElement.srcObject = currentStream;
                welcomeScreen.classList.add('hidden');
                cameraScreen.classList.remove('hidden');
                checkCameraSwitchAvailability();
                setupZoomControls();
            }
            
            function getCameraStream(facingMode) {
                return navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { exact: facingMode }, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
            }
            
            function handleCameraError(err) {
                let message = "Произошла неизвестная ошибка при доступе к камере.";
                if (err.name === "NotAllowedError") {
                    message = "Вы не разрешили доступ к камере. Пожалуйста, обновите страницу и предоставьте разрешение.";
                } else if (err.name === "NotFoundError" || err.name === "OverconstrainedError" || err.name === "NotReadableError") {
                    message = "Не удалось найти подходящую камеру на вашем устройстве.";
                }
                showMessage(message);
                welcomeScreen.classList.remove('hidden');
                cameraScreen.classList.add('hidden');
            }

            async function checkCameraSwitchAvailability() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoInputs = devices.filter(device => device.kind === 'videoinput');
                    switchCameraBtn.classList.toggle('hidden', videoInputs.length <= 1);
                } catch(e) {
                    switchCameraBtn.classList.add('hidden');
                }
            }

            function switchCamera() {
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                startCamera();
            }

            function setupZoomControls() {
                const videoTrack = currentStream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities();
                supportsZoom = !!capabilities.zoom;
                if (supportsZoom) {
                    minZoom = capabilities.zoom.min;
                    maxZoom = capabilities.zoom.max;
                    zoomSlider.min = minZoom;
                    zoomSlider.max = maxZoom;
                    zoomSlider.step = capabilities.zoom.step || 0.1;
                    zoomSlider.value = currentZoom = videoTrack.getSettings().zoom || 1.0;
                    zoomControls.classList.remove('hidden');
                    zoomSlider.addEventListener('input', (e) => applyZoom(parseFloat(e.target.value)));
                    videoElement.addEventListener('touchstart', handleTouchStart, false);
                    videoElement.addEventListener('touchmove', handleTouchMove, false);
                } else {
                    zoomControls.classList.add('hidden');
                }
            }

            function applyZoom(zoomValue) {
                if (supportsZoom) {
                    const videoTrack = currentStream.getVideoTracks()[0];
                    currentZoom = Math.max(minZoom, Math.min(maxZoom, zoomValue));
                    videoTrack.applyConstraints({ advanced: [{ zoom: currentZoom }] });
                    zoomSlider.value = currentZoom;
                }
            }

            function handleTouchStart(event) {
                if (event.touches.length === 2) initialPinchDistance = getPinchDistance(event.touches);
            }

            function handleTouchMove(event) {
                if (event.touches.length === 2 && initialPinchDistance) {
                    const newPinchDistance = getPinchDistance(event.touches);
                    applyZoom(currentZoom * (newPinchDistance / initialPinchDistance));
                    initialPinchDistance = newPinchDistance;
                }
            }

            function getPinchDistance(touches) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            function takePhoto() {
                if (photosTaken >= PHOTO_LIMIT) {
                    showMessage('Вы достигли лимита в 25 фотографий!');
                    return;
                }
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                const watermarkText = `${userName} | Илья & Алина 28.08.2025`;
                context.font = '30px Inter, sans-serif';
                context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                context.textAlign = 'right';
                context.textBaseline = 'bottom';
                context.fillText(watermarkText, canvas.width - 20, canvas.height - 20);
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                displayPhotoInGallery(imageDataUrl);
                savePhotoToStorage(imageDataUrl);
                showNotification(messages[photosTaken % messages.length]);
                photosTaken++;
                localStorage.setItem('weddingPhotosTakenCount', photosTaken);
                updatePhotoCounter();
            }

            function showNotification(message) {
                notificationMessageEl.textContent = message;
                notificationPopup.classList.add('show');
                notificationSound.play().catch(()=>{});
                setTimeout(() => notificationPopup.classList.remove('show'), 4000);
            }

            function updatePhotoCounter() {
                const remaining = PHOTO_LIMIT - photosTaken;
                photoCounterEl.textContent = remaining;
                if (remaining <= 0) {
                    takePhotoBtn.disabled = true;
                    takePhotoBtn.style.opacity = '0.5';
                }
            }
            
            function displayPhotoInGallery(imageDataUrl) {
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.className = 'w-16 h-16 object-cover rounded-md border-2 border-white shadow-md fade-in cursor-pointer';
                img.addEventListener('click', () => {
                    fullSizePhoto.src = imageDataUrl;
                    photoViewerModal.classList.remove('hidden');
                });
                galleryContainer.appendChild(img);
                shareOrDownloadBtn.classList.remove('hidden');
            }

            function savePhotoToStorage(imageDataUrl) {
                const photos = JSON.parse(localStorage.getItem('weddingPhotos') || '[]');
                photos.push(imageDataUrl);
                localStorage.setItem('weddingPhotos', JSON.stringify(photos));
            }

            function loadPhotosFromStorage() {
                const photos = JSON.parse(localStorage.getItem('weddingPhotos') || '[]');
                photos.forEach(displayPhotoInGallery);
                if (photos.length > 0) {
                    shareOrDownloadBtn.classList.remove('hidden');
                }
            }

            // *** NEW LOGIC HERE ***
            async function shareOrDownloadPhotos() {
                const photos = JSON.parse(localStorage.getItem('weddingPhotos') || '[]');
                if (photos.length === 0) {
                    showMessage("Сначала сделайте хотя бы одно фото.");
                    return;
                }

                showMessage("Готовим ваши фото...");
                shareOrDownloadBtn.disabled = true;

                try {
                    const zip = new JSZip();
                    for (let i = 0; i < photos.length; i++) {
                        const base64Data = photos[i].split(',')[1];
                        zip.file(`${userName}_photo_${i + 1}.jpeg`, base64Data, { base64: true });
                    }
                    const blob = await zip.generateAsync({ type: "blob" });
                    const fileName = `Фото от ${userName} (Свадьба Ильи и Алины).zip`;
                    const file = new File([blob], fileName, { type: 'application/zip' });
                    
                    // Проверяем, поддерживается ли Web Share API
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        // Используем Web Share API
                        await navigator.share({
                            files: [file],
                            title: 'Фото со свадьбы',
                            text: `Фотографии от гостя (${userName}) со свадьбы Ильи и Алины!`,
                        });
                        messageBox.classList.add('hidden'); // Закрываем сообщение о подготовке
                    } else {
                        // Возвращаемся к старому методу, если Web Share API не поддерживается
                        throw new Error('Web Share API not supported');
                    }
                } catch (error) {
                    // Этот блок сработает, если Web Share API не поддерживается ИЛИ если пользователь закрыл меню "Поделиться"
                    console.log('Web Share API failed, falling back to download.', error);
                    // Скачиваем файл и показываем инструкцию
                    const photos = JSON.parse(localStorage.getItem('weddingPhotos') || '[]');
                    const zip = new JSZip();
                     for (let i = 0; i < photos.length; i++) {
                        const base64Data = photos[i].split(',')[1];
                        zip.file(`${userName}_photo_${i + 1}.jpeg`, base64Data, { base64: true });
                    }
                    const content = await zip.generateAsync({ type: "blob" });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = `Фото от ${userName} (Свадьба Ильи и Алины).zip`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    
                    showMessage("", true); // Показываем модальное окно с ручной инструкцией
                } finally {
                    shareOrDownloadBtn.disabled = false;
                }
            }

            init();
        });
    </script>
</body>
</html>
